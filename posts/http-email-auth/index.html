<!doctype html><html>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="おしんこのブログ">
<meta name=robots content="max-image-preview:large">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:creator content="@osynco">
<meta name=twitter:site content="@osynco">
<meta name=twitter:title content="HTTP Email Authentication - Osync I/O">
<meta property="og:type" content="article">
<meta property="og:site_name" content="Osync I/O">
<meta property="og:locale" content="ja_JP">
<meta property="og:url" content="https://osync.io/posts/http-email-auth/">
<meta property="og:title" content="HTTP Email Authentication - Osync I/O">
<meta property="og:description" content="Email を利用した HTTP 認証スキームです。 メールによるワンタイムパスワードなど、パスワードレス認証の実現を目的とした、 HMAC ベースのテンポラリトークン認証">
<meta property="og:image" content="https://osync.io/images/headers/http-email-auth.jpg">
<title>HTTP Email Authentication - Osync I/O</title>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-JQCHZM9PGG"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-JQCHZM9PGG',{anonymize_ip:!1})}</script>
<style>:root{--color-link:#499bea;--color-link-hover:#304999;--color-muted:#7d8590;--font-base:-apple-system, "BlinkMacSystemFont",
                   "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo,
                   sans-serif, "Segoe UI Emoji";--font-code:"SFMono-Regular", Consolas, "Liberation Mono", Menlo,
                   monospace, "Segoe UI Emoji";--header-grad-start:var(--color-link);--header-grad-end:var(--color-link-hover)}*,*::before,*::after{box-sizing:border-box}@font-face{font-family:flop;src:url(/fonts/flop/FLOPDesignFont.woff2)format("woff2"),url(/fonts/flop/FLOPDesignFont.woff)format("woff");font-weight:400}img{max-width:100%}body{margin:0;font-family:var(--font-base);background-color:#e7f4ff}a{color:var(--color-link);text-decoration:none}a:hover{color:var(--color-link-hover)}code{padding:.2em .4em;border-radius:6px;background-color:#818b981f;font-size:85%;font-family:var(--font-code)}pre code{border:1px solid #999;display:block;padding:1em;line-height:1.45em;overflow:auto;background-color:inherit;border-radius:0}header{padding:1em;background:linear-gradient(to top,var(--header-grad-start) 0%,var(--header-grad-end) 100%);color:#b6cee2;font-size:1.2em;text-align:center}header h1{margin:0 0 .4em;color:#fff;font-family:flop}header h1 a{color:inherit;text-decoration:none}header h1 a:hover{color:#b6cee2}header p{margin:0;font-size:.8em}nav{margin:1em}@media screen and (min-width:920px){nav{width:912px;margin-left:auto;margin-right:auto}}nav ul{display:flex;column-gap:1em;margin:0;padding:0;list-style:none}nav li{line-height:1.6;padding-bottom:.1em;border-bottom:2px solid #fff}nav li.selected{border-bottom:2px solid #cc0051}@media screen and (min-width:480px){main{margin:1em}}@media screen and (min-width:920px){main{width:920px;margin-left:auto;margin-right:auto}}.article-list{display:flex;flex-direction:column;gap:16px}@media screen and (min-width:920px){.article-list{flex-direction:row;flex-wrap:wrap}.article-wrapper.col2{width:448px}.article-wrapper.col4{width:216px}}article{margin:0;padding:1em;background-color:#fff}article .info{margin-block:3em;h1 { font-size: 2em; }}article h1{margin-block:.6em;font-size:1.5em}article h2{position:relative;padding:.6em 1em;background-color:#61a5e4;border-radius:7px;color:#fff;font-size:1.25em}article h2 a{color:#fff}article h2:after{position:absolute;content:'';top:100%;left:30px;border:8px solid transparent;border-top:8px solid #61a5e4;width:0;height:0}article h3{padding:.25em 0 .25em .6em;border-left:.4em solid var(--color-link);font-size:1.125em}article ul.tags{margin:.5em 0;padding:0;list-style:none;font-size:.8em;li { display: inline; line-height: 1.6; }}article .date{display:flex;column-gap:1em;row-gap:.5em;flex-wrap:wrap;margin:0;font-size:.8em}article .date>*{display:flex;gap:.25em}article .date>*>:first-child:after{content:":"}.toppage article.outline{@media screen and (min-width:920px){height: 430px; } p { margin-block: .5em 0; } } section li { line-height: 1.6; } footer { margin: 1em; } footer ul { margin: 0; padding: 0 0 0; list-style: none; text-align: center; } footer li { display: inline; line-height: 1.6; } footer small { display: block; margin: 1em; text-align: center; color: #666; } .responsive { position: relative; padding-bottom: 75%; } .responsive>* { position: absolute; top: 0; left: 0; width: 100%; height: 120%; } ul.pagination { margin: 1em 0; padding: 0; font-family: tahoma,sans-serif; } ul.pagination li { display: inline; padding: .2em; } blockquote { padding-left: 1em; border-left: .25em solid #dfe2e5; color: var(--color-muted); margin: 1em 0; } table { border-collapse: collapse; margin-block: 1em; } table thead { position: sticky; top: 0; z-index: 1; background-color: #eee; color: #24292e; } table th,table td { padding: 10px; border: 1px solid #dfe2e5; text-align: left; } .fade { transition: opacity .2s ease-in-out; } .fade:hover { opacity: .5; }}}</style>
</head>
<body>
<header>
<h1><a href=/>Osync I/O</a></h1>
<p>おしんこのブログ</p>
</header>
<nav>
<ul>
<li>
<a href=/posts/>Posts</a></li>
<li>
<a href=/tags/>Tags</a></li>
<li>
<a href=/about/>About</a></li>
</ul>
</nav>
<main>
<article>
<img src=/images/headers/http-email-auth.jpg>
<div class=info>
<h1>HTTP Email Authentication</h1>
<div class=date>
<div>
<div>Last committed</div>
<time datetime=2022-06-18T00:24:12Z+0900>
22/06/18 00:24
</time>
</div>
<div>
<div>Posted</div>
<time datetime=2018-07-21T22:30:00Z+0900>
18/07/21 22:30
</time>
</div>
</div>
<ul class=tags>
<li><a href=/tags/http/>HTTP</a></li>
<li><a href=/tags/email/>Email</a></li>
<li><a href=/tags/auth/>Auth</a></li>
</ul>
</div>
<section><p>Email を利用した HTTP 認証スキームです。</p>
<p>メールによるワンタイムパスワードなど、パスワードレス認証の実現を目的とした、 HMAC ベースのテンポラリトークン認証スキームとなっています。</p>
<p>具体的な実装は、 <a href=https://github.com/oshinko/pyhttpauth>Python パッケージ</a>で確認できます。</p>
<h2 id=認証を開始する>認証を開始する</h2>
<p><code>POST /email/auth</code> が認証を開始する API と仮定します。</p>
<p>HTTP リクエストと同時に、本文にパスワードを含んだメールが送信されます。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ curl -v -d <span style=color:#e6db74>&#39;[&#34;me@domain&#34;]&#39;</span> http://localhost:8080/email/auth
*   Trying 127.0.0.1...
* TCP_NODELAY set
* Connected to 127.0.0.1 <span style=color:#f92672>(</span>127.0.0.1<span style=color:#f92672>)</span> port <span style=color:#ae81ff>8080</span> <span style=color:#f92672>(</span><span style=color:#75715e>#0)</span>
&gt; POST /email/auth HTTP/1.1
&gt; Host: 127.0.0.1:8080
&gt; User-Agent: curl/7.54.0
&gt; Accept: */*
&gt; Content-Length: <span style=color:#ae81ff>13</span>
&gt; Content-Type: application/x-www-form-urlencoded
&gt; 
* upload completely sent off: <span style=color:#ae81ff>13</span> out of <span style=color:#ae81ff>13</span> bytes
* HTTP 1.0, assume close after body
&lt; HTTP/1.0 <span style=color:#ae81ff>200</span> OK
&lt; Content-Type: application/json
&lt; Content-Length: <span style=color:#ae81ff>71</span>
&lt; Server: Werkzeug/0.14.1 Python/3.7.0
&lt; Date: Sat, <span style=color:#ae81ff>21</span> Jul <span style=color:#ae81ff>2018</span> 11:00:05 GMT
&lt; 
<span style=color:#e6db74>&#34;BFtTJNUNWyJtZUBkb21haW4iXV9ord26MiebdfzlAtj6+cU6huRLELVo3og6NeFHfHcP&#34;</span>
* Closing connection <span style=color:#ae81ff>0</span>
</code></pre></div><p>レスポンスボディには、 Hint と呼ばれるトークンが含まれます。</p>
<p>Hint を環境変数に設定するには、次のようなコマンドを実行します。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>HINT<span style=color:#f92672>=</span><span style=color:#e6db74>`</span>curl -d <span style=color:#e6db74>&#39;[&#34;me@domain&#34;]&#39;</span> http://localhost:8080/email/auth | sed -e <span style=color:#e6db74>&#39;s/^&#34;//&#39;</span> -e <span style=color:#e6db74>&#39;s/&#34;$//&#39;</span><span style=color:#e6db74>`</span>
</code></pre></div><h2 id=アクセストークンを取得する>アクセストークンを取得する</h2>
<p>次に、メールに送信された認可情報を提示して、アクセストークンを取得します。</p>
<p>認可情報は、 Authorization ヘッダにあるように、メールアドレスとパスワードの組み合わせに <code>POST /email/auth</code> で得た Hint を加えた情報です。</p>
<p><code>GET /email/token</code> が、その役割を担う API と仮定します。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ ADDR<span style=color:#f92672>=</span><span style=color:#e6db74>`</span>echo -n me@domain | base64<span style=color:#e6db74>`</span>
$ PASS<span style=color:#f92672>=</span><span style=color:#e6db74>`</span>echo -n $RECEIVED_PASSWORD | base64<span style=color:#e6db74>`</span>
$ curl -v -H <span style=color:#e6db74>&#34;Authorization: Email </span>$ADDR<span style=color:#e6db74> </span>$PASS<span style=color:#e6db74> </span>$HINT<span style=color:#e6db74>&#34;</span> http://localhost:8080/email/token
*   Trying 127.0.0.1...
* TCP_NODELAY set
* Connected to localhost <span style=color:#f92672>(</span>127.0.0.1<span style=color:#f92672>)</span> port <span style=color:#ae81ff>8080</span> <span style=color:#f92672>(</span><span style=color:#75715e>#0)</span>
&gt; GET /email/token HTTP/1.1
&gt; Host: localhost:8080
&gt; User-Agent: curl/7.54.0
&gt; Accept: */*
&gt; Authorization: Email bWVAZG9tYWlu WERPRUFSU1FRSlA1 BFtTJNUNWyJtZUBkb21haW4iXV9ord26MiebdfzlAtj6+cU6huRLELVo3og6NeFHfHcP
&gt; 
* HTTP 1.0, assume close after body
&lt; HTTP/1.0 <span style=color:#ae81ff>200</span> OK
&lt; Content-Type: application/json
&lt; Content-Length: <span style=color:#ae81ff>71</span>
&lt; Server: Werkzeug/0.14.1 Python/3.7.0
&lt; Date: Sat, <span style=color:#ae81ff>21</span> Jul <span style=color:#ae81ff>2018</span> 11:22:48 GMT
&lt; 
<span style=color:#e6db74>&#34;BFtTJZgNWyJtZUBkb21haW4iXbr2VN4a4l0+wARNQSuyx7AldqU6V9PEojuqHxmCUmD9&#34;</span>
* Closing connection <span style=color:#ae81ff>0</span>
</code></pre></div><p>メールアドレスとパスワードは、任意のデータを許容する目的で Base64 エンコードを施します。</p>
<p>アクセストークンを環境変数に設定するには、次のようなコマンドを実行します。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>TOKEN<span style=color:#f92672>=</span><span style=color:#e6db74>`</span>curl -H <span style=color:#e6db74>&#34;Authorization: Email </span>$ADDR<span style=color:#e6db74> </span>$PASS<span style=color:#e6db74> </span>$HINT<span style=color:#e6db74>&#34;</span> http://localhost:8080/email/token | sed -e <span style=color:#e6db74>&#39;s/^&#34;//&#39;</span> -e <span style=color:#e6db74>&#39;s/&#34;$//&#39;</span><span style=color:#e6db74>`</span>
</code></pre></div><h2 id=hint-について>Hint について</h2>
<p>Hint は、認証を開始してからの有効期限と、ユーザー任意のペイロード、認可情報の HMAC 署名を含むトークンです。</p>
<p>メールアドレスに送信されるパスワードをサーバーの秘密鍵で暗号化したデータであり、これを参照して認証を行います。</p>
<p>次の疑似コードは、 Hint の作成例です。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>Secret <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Your secret words&#34;</span>
Address <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;me@domain&#34;</span>
Password <span style=color:#f92672>=</span> RANDOM<span style=color:#f92672>()</span>
Expires <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;2018-01-01T00:00:00&#34;</span>
Payload <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Hello!&#34;</span>
Answer <span style=color:#f92672>=</span> Address + <span style=color:#e6db74>&#34; &#34;</span> + Password + <span style=color:#e6db74>&#34; &#34;</span> + Expires + <span style=color:#e6db74>&#34; &#34;</span> + Payload
Signature <span style=color:#f92672>=</span> HMACSHA256<span style=color:#f92672>(</span>Secret, Answer<span style=color:#f92672>)</span>
Hint <span style=color:#f92672>=</span> BASE64<span style=color:#f92672>(</span>Expires + Payload + Signature<span style=color:#f92672>)</span>
</code></pre></div><h2 id=認証により保護されたリソースにアクセスする>認証により保護されたリソースにアクセスする</h2>
<p>最後に、保護されたリソースにアクセスする一例を示します。</p>
<p>メール認証によって得られたアクセストークンをサーバーに提示することで、アクセス権を証明します。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ curl -v -H <span style=color:#e6db74>&#34;Authorization: Email-Token </span>$TOKEN<span style=color:#e6db74>&#34;</span> http://localhost:8080/locked/contents
*   Trying 127.0.0.1...
* TCP_NODELAY set
* Connected to localhost <span style=color:#f92672>(</span>127.0.0.1<span style=color:#f92672>)</span> port <span style=color:#ae81ff>8080</span> <span style=color:#f92672>(</span><span style=color:#75715e>#0)</span>
&gt; GET /locked/contents HTTP/1.1
&gt; Host: localhost:8080
&gt; User-Agent: curl/7.54.0
&gt; Accept: */*
&gt; Authorization: Email-Token BFtTPhgNWyJtZUBkb21haW4iXbhKH/OE+DIYewHWFsiAZpL9zPgybYZDm423EhPzrzDT
&gt; 
* HTTP 1.0, assume close after body
&lt; HTTP/1.0 <span style=color:#ae81ff>200</span> OK
&lt; Content-Type: application/json
&lt; Content-Length: <span style=color:#ae81ff>29</span>
&lt; Server: Werkzeug/0.14.1 Python/3.7.0
&lt; Date: Sat, <span style=color:#ae81ff>21</span> Jul <span style=color:#ae81ff>2018</span> 13:07:30 GMT
&lt; 
<span style=color:#f92672>{</span>
  <span style=color:#e6db74>&#34;welcome&#34;</span>: <span style=color:#e6db74>&#34;me@domain&#34;</span>
<span style=color:#f92672>}</span>
* Closing connection <span style=color:#ae81ff>0</span>
</code></pre></div><p>以上、メール認証によって証明されたアドレスの所有権がないと取得できない情報や、操作できない機能を実装する上での参考になればと思います。</p>
</section>
</article>
<script>var submittedMessage=!1;function handleMessageSubmit(b){b.target.querySelector('input[type="hidden"]').value=location.href;const a=confirm('メッセージを送信します。よろしいですか？');return b.target.querySelector('button').disabled=a,b.target.querySelector('textarea').readOnly=a,submittedMessage=a,a}</script>
<div style=margin-top:1em>
<form action=https://docs.google.com/forms/d/e/1FAIpQLSdNRP2vN3NEer3hwIrNEFIAf2dfNSzcwnd42tQYhkruGa7K_A/formResponse method=post onsubmit="return handleMessageSubmit(event)" target=hidden style=display:flex;flex-direction:column;gap:.75em>
<input type=hidden name=entry.1054445216>
<textarea name=entry.1359947595 placeholder=このページに関するご指摘・ご意見などを送信下さい。 rows=10 cols=40 maxlength=400 required style=padding:1em></textarea>
<button style="width:max-content;padding:.4em 1.5em">送信</button>
</form>
<iframe name=hidden style=display:none onload="submittedMessage&&alert('ご協力ありがとうございます。メッセージを送信しました。')"></iframe>
</div>
</main>
<footer>
<ul>
<li>
<a href=https://discord.gg/JhgFz8u>Discord</a>
<a href=https://github.com/oshinko>GitHub</a>
<a href=https://x.com/Osynco>X.com</a>
<a href=https://bsky.app/profile/osync.io>Bluesky</a>
<a href=https://snort.social/p/npub1xx3kyu57uqukvsxmlhnmafv825pct93455hkn544nd6exlnunxps2psn5q>Nostr</a>
</li>
</ul>
<small>
(C) 2025 Osync I/O.
Powered by <a href=https://gohugo.io>Hugo</a>.
</small>
</footer>
</body>
</html>